# ============================================
# cron_tasks/curfew_alert.rb (출석 마감 메시지 삭제, 통금만 남김)
# ============================================
require_relative '../utils/professor_control'

CURFEW_MESSAGES = [
  "이제 통금 시간이에요. 기숙사로 돌아가서 푹 쉬세요.",
  "늦은 시간이군요. 방으로 들어가서 따뜻하게 있어요.",
  "밤은 쉬는 시간이에요. 기숙사에서 편히 있으세요.",
  "오늘도 고생 많았어요. 이제 쉴 시간이에요.",
  "통금 시간이에요. 안전하게 방에 있으세요.",
  "교수도 이제 잘 시간이에요. 학생들도 쉬세요.",
  "밤이 깊었군요. 기숙사 밖은 나가지 마세요.",
  "내일을 위해 오늘은 푹 쉬어야 해요.",
  "늦은 밤엔 몸도 마음도 쉬어야지요. 방에 있어요.",
  "통금 시간이에요. 복도도 조용히 해주세요.",
  "교수가 불을 끌 시간이에요. 학생들도 자요.",
  "오늘 하루 정말 수고했어요. 이제 쉬어도 돼요.",
  "밤엔 다들 기숙사에 있어야 안심이에요.",
  "통금 시간 지키는 게 교수와의 약속이에요.",
  "늦게까지 공부했군요. 이제 자요.",
  "기숙사가 제일 안전한 곳이에요. 방에 있어요.",
  "밤 공기는 차가우니 밖에 나가지 마세요.",
  "오늘 배운 것 생각하며 쉬는 것도 공부예요.",
  "교수가 학생들 안전을 지켜야 하니까 통금이에요.",
  "늦은 밤엔 조용히 해야 해요. 방에 있으세요.",
  "통금 시간이에요. 내일 아침 건강하게 봐요.",
  "밤이 깊으니 이불 속에서 따뜻하게 있어요.",
  "오늘도 무사히 보냈으니 감사하며 쉬세요.",
  "교수도 학생들도 모두 쉴 시간이에요.",
  "통금 시간엔 복도 다니지 말고 방에만 있어요.",
  "내일 아침 맑은 얼굴로 보려면 지금 자야 해요.",
  "늦은 시간까지 깨어있으면 내일 피곤해요.",
  "기숙사 문 닫을 시간이에요. 안전하게 있으세요.",
  "오늘 하루도 교수 덕분에 기쁘네요. 푹 쉬세요.",
  "통금 시간이에요. 조용히 쉬다가 내일 봐요."
]

def run_curfew_alert(sheet_manager, mastodon_client)
  puts "[통금 알림] #{Time.now.strftime('%Y-%m-%d %H:%M:%S')} - 실행 시작"
  
  # ProfessorControl 모듈 메서드 직접 호출
  enabled = ProfessorControl.auto_push_enabled?(sheet_manager, "통금알람")
  puts "[통금 알림] 기능 상태: #{enabled ? 'ON' : 'OFF'}"
  
  unless enabled
    puts "[스킵] 통금알람이 OFF 상태입니다."
    return
  end

  message = CURFEW_MESSAGES.sample
  puts "[통금 알림] 전송할 메시지: #{message}"
  
  begin
    mastodon_client.broadcast(message)
    puts "[통금 알림] 전송 완료"
  rescue => e
    puts "[에러] 통금 알림 전송 실패: #{e.message}"
    puts e.backtrace.first(3)
  end
end
